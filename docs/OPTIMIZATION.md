# 优化记录

### 优化建议与实施计划

本文件列出项目的优化建议、价值说明、实施要点与进度，作为后续迭代的执行清单与对外说明。

#### 目标

* 提升安全性与稳定性
* 优化上传与文件保存的可靠性
* 提高可维护性与可观测性

***

### 第一阶段（已实施/优先实施）

#### 1) 文件名/路径稳健性（已实施）

* **变更**：
  * `GenerateUniqueFilename` 使用 `os.Stat` 判断文件存在性，避免 `filepath.EvalSymlinks` 的误用与潜在风险
  * `EnsureExtension` 仅在"无扩展名"时补齐 `.mp4`，若已有任何扩展名则保持不动
  * `CleanFilename` 清理非法字符，移除 Windows 非法字符和控制字符
  * `CleanFolderName` 清理文件夹名称，确保目录名合法
  * 重名文件自动添加序号 `(1)`, `(2)` 等，最多尝试 `maxAttempts` 次
* **价值**：
  * 避免误判导致的覆盖或异常
  * 更符合用户对扩展名的预期
  * 保证文件名和路径的合法性
  * 自动处理重名冲突
* **影响范围**：
  * `internal/utils/filename.go`
* **技术细节**：
  * 清理的非法字符包括：`<>:"/\|?*` 和控制字符
  * 如果所有尝试都失败，添加时间戳作为后缀
  * 支持自定义最大尝试次数

#### 2) 统一安全响应头（已实施）

* **变更**：
  * 为所有 API 响应添加 `X-Content-Type-Options: nosniff` 响应头
  * 包括成功响应、错误响应、空响应等所有情况
  * 统一在响应头设置，保证一致性
* **价值**：
  * 提升基础安全性
  * 降低内容嗅探相关风险
  * 防止 MIME 类型混淆攻击
  * 符合安全最佳实践
* **影响范围**：
  * `internal/handlers/api.go`（API 处理器）
  * `internal/handlers/record.go`（记录处理器）
  * `internal/handlers/upload.go`（上传处理器）
  * `internal/handlers/batch.go`（批量处理器）
* **技术细节**：
  * 在所有 JSON 响应和空响应中统一添加
  * 使用 `headers.Set("X-Content-Type-Options", "nosniff")` 设置
  * 覆盖所有错误场景（401、404、500 等）

***

### 第二阶段（建议优先级：高）

#### 3) 认证与来源校验（已实施）

* **变更**：
  * 支持本地授权令牌：设置环境变量 `WX_CHANNEL_TOKEN` 后，所有接口需在请求头携带 `X-Local-Auth: <token>` 才会被接受；不设置则保持兼容、无需校验
  * 支持 `WX_CHANNEL_ALLOWED_ORIGINS`（逗号分隔）。当配置存在时，仅允许匹配的 `Origin` 调用接口（为空的 `Origin` 不拦截）
  * 支持 CORS 预检：统一回复 `POST, OPTIONS` 与 `Content-Type, X-Local-Auth` 允许头
  * 所有 API 响应添加安全响应头 `X-Content-Type-Options: nosniff`
* **价值**：
  * 提高接口安全性
  * 防止未授权访问
  * 支持跨域访问控制
  * 降低内容嗅探风险
* **影响范围**：
  * `internal/config/config.go`（配置加载）
  * `internal/handlers/*.go`（所有处理器）
  * `main.go`（CORS 预检处理）
* **后续计划**：
  * 添加 `127.0.0.1` 访问限制（可选）
  * 支持 IP 白名单
  * 支持更细粒度的权限控制

#### 4) 上传完整性与断点续传（已实施）

* **变更**：
  * 分片可选校验：在 `upload_chunk` 表单中传 `checksum` 与 `algo`（`md5`/`sha256`），服务端流式校验并在不匹配时拒绝
  * `complete_upload` 会先校验所有分片是否存在；后续可加入大小校验
  * 新增 `upload_status` 接口查询已上传分片列表，支持断点续传
  * 上传并发限流：分片/合并分别受 `UploadChunkConcurrency`/`UploadMergeConcurrency` 控制
  * 使用临时文件（`.part`）保存分片，合并时原子操作
* **价值**：
  * 保证上传数据完整性
  * 支持大文件上传
  * 支持断点续传，提高可靠性
  * 控制并发，避免资源耗尽
* **影响范围**：
  * `internal/handlers/upload.go`（上传处理）
  * `internal/config/config.go`（并发配置）
* **技术细节**：
  * 分片保存在 `downloads/.uploads/<uploadId>/<index>.part`
  * 合并时使用原子重命名，避免半成品文件
  * 支持 MD5 和 SHA256 两种校验算法

#### 后端批量下载与解密（已实施）

* **变更**：
  * 前端在批量/选中提交时，若视频有 key，则生成 `decryptor_array`，取前 128 KiB 作为 `decryptorPrefix`（base64）并携带 `prefixLen`
  * 后端仅对前缀做异或解密，后续数据原样写入；使用临时文件原子落盘
  * 队列去重（id/url）与同名非空文件跳过，避免重复下载与半成品
  * 支持强制重新下载选项（`forceRedownload`）
  * 使用工作协程池处理下载任务，支持并发控制
  * 失败任务自动重试，支持自定义重试次数
* **价值**：
  * 支持加密视频的批量下载
  * 提高下载效率（并发下载）
  * 避免重复下载，节省资源
  * 提高下载可靠性（重试机制）
  * 保证文件完整性（原子操作）
* **影响范围**：
  * `internal/services/downloader.go`（下载服务）
  * `internal/handlers/batch.go`（批量处理接口）
  * `inject/main.js`（前端解密逻辑）
* **技术细节**：
  * 使用 `context.Context` 支持取消操作
  * 使用 `sync.Mutex` 保证并发安全
  * 临时文件使用 `.downloading` 后缀，完成后原子重命名
  * 去重逻辑：优先使用 ID，其次使用 URL
  * 支持查看进度：`total/done/failed/running`
  * 失败清单导出为 JSON 格式，便于重试

#### 5) CSV 去重性能优化（已实施）

* **变更**：
  * 启动时扫描 CSV 构建内存索引 `map[id]struct{}`，写入 O(1) 去重
  * 记录 ID 为空时跳过，避免无效记录
  * 使用 `sync.Mutex` 保证并发安全
* **价值**：
  * 大幅提升去重性能（从 O(n) 到 O(1)）
  * 减少 CSV 文件写入次数
  * 避免重复记录占用空间
* **影响范围**：
  * `internal/storage/csv.go`（CSV 管理器）
* **技术细节**：
  * 启动时调用 `loadIndex()` 加载所有已存在的 ID
  * 写入时先检查内存索引，存在则跳过
  * 写入成功后更新内存索引

#### 使用说明补充

* 可选本地令牌：
  * 启动前设置 `WX_CHANNEL_TOKEN=你的密钥`
  * 前端/调用方请求头需携带：`X-Local-Auth: 你的密钥`

***

### 第三阶段（建议优先级：中）

#### 6) 日志与可观测性

* （已实施第一步）支持文件大小滚动日志：`WX_CHANNEL_LOG_FILE` + `WX_CHANNEL_LOG_MAX_MB`
* 后续可加入按日滚动与 JSON 结构化日志，错误码与建议操作。

#### 7) 配置与版本化

* 支持 `config.json`/环境变量加载，命令行覆盖；版本语义化并在构建时注入。

#### 8) 下载目录策略

* 支持选择保存根目录、作者子目录开关、文件名模板（时间戳/作者/标题/ID）。

***

### 第四阶段（建议优先级：低）

#### 9) 批量下载增强

* （已实施第一步）队列并发控制与失败重试（`DownloadConcurrency`、`DownloadRetryCount`），提供 start/progress/cancel 接口。
* （已实施第二步）失败清单导出接口：`batch_failed` 返回 JSON 文件路径。
* 后续：进度持久化（重启恢复）。

#### 10) 导出格式与托盘

* （已实施第一步）支持 JSON/Markdown 批量导出接口：`export_video_list_json`、`export_video_list_md`。
* Windows 托盘图标、打开下载目录、启动/停止代理、查看日志（待定）。

***

### 已实施优化详细说明

#### UI/UX 优化（v20251104）

**状态信息栏**

* **实施时间**：v20251104
* **变更**：
  * 替代浏览器原生 `alert`，提供更美观的提示体验
  * 支持多种消息类型（信息/成功/警告/错误），不同颜色区分
  * 使用半透明背景和柔和色调，视觉更舒适
  * 自动淡入淡出动画，支持自定义显示时长
* **价值**：
  * 提升用户体验，避免原生弹窗的突兀感
  * 统一 UI 风格，与整体界面协调
* **影响范围**：
  * `inject/main.js`（前端注入脚本）

**自定义确认对话框**

* **实施时间**：v20251104
* **变更**：
  * 替代浏览器原生 `confirm`
  * 深色主题，与整体 UI 风格统一
  * 支持点击遮罩或 ESC 键取消
  * 更友好的交互体验
* **价值**：
  * 统一交互体验
  * 更好的可定制性
* **影响范围**：
  * `inject/main.js`（前端注入脚本）

#### 批量下载功能增强

**前端批量下载与选择下载**

* **实施时间**：v20251104
* **变更**：
  * "编辑选择"展开选择列表（可勾选需要下载的视频）
  * 每项展示：标题、封面、创建时间、时长、大小
  * "仅选中-前端下载"：前端解密 → 分片上传保存；可见进度；支持取消
  * "仅选中-后端下载"：将勾选清单提交给后端队列
  * "导出链接"支持多格式选择（TXT/JSON/Markdown）
  * 前端批量下载支持即时取消（AbortController）
* **价值**：
  * 提供更灵活的下载选择
  * 支持批量操作，提高效率
  * 多格式导出，满足不同需求
* **影响范围**：
  * `inject/main.js`（前端注入脚本）
  * `internal/handlers/batch.go`（后端批量处理）

**后端批量下载增强**

* **实施时间**：v20251104
* **变更**：
  * 队列并发控制与失败重试（`DownloadConcurrency`、`DownloadRetryCount`）
  * 提供 start/progress/cancel 接口
  * 失败清单导出接口：`batch_failed` 返回 JSON 文件路径
  * 进程内去重（按 `id` 优先，其次 `url`）
  * 同名非空文件直接跳过（避免重复副本）
  * 支持强制重新下载选项
* **价值**：
  * 提高下载可靠性
  * 避免重复下载，节省资源
  * 便于失败重试
* **影响范围**：
  * `internal/services/downloader.go`（下载服务）
  * `internal/handlers/batch.go`（批量处理接口）

#### 解密功能优化

**前缀解密**

* **实施时间**：v20251104
* **变更**：
  * 前端在批量/选中提交时，若视频有 key，则生成 `decryptor_array`
  * 取前 128 KiB 作为 `decryptorPrefix`（base64）并携带 `prefixLen`
  * 后端仅对前缀做异或解密，后续数据原样写入
  * 使用临时文件原子落盘（`.downloading` 后缀），避免半成品
* **价值**：
  * 支持加密视频的下载
  * 提高解密效率（仅解密前缀）
  * 保证文件完整性
* **影响范围**：
  * `inject/main.js`（前端解密逻辑）
  * `internal/services/downloader.go`（后端解密处理）

#### 导出功能增强

**多格式导出**

* **实施时间**：v20251104
* **变更**：
  * 前端导出支持 TXT/JSON/Markdown 三种格式
  * 字段包含：标题、ID、URL、KEY、作者、时长、大小、点赞、评论、收藏、转发、创建时间、封面
  * 后端导出接口：`export_video_list_json`、`export_video_list_md`
* **价值**：
  * 满足不同使用场景
  * 提供更丰富的数据格式
* **影响范围**：
  * `inject/main.js`（前端导出）
  * `internal/handlers/record.go`（后端导出接口）

#### 日志系统优化

**文件大小滚动日志**

* **实施时间**：v20251108
* **变更**：
  * 支持文件大小滚动日志：`WX_CHANNEL_LOG_FILE` + `WX_CHANNEL_LOG_MAX_MB`
  * 默认开启：日志写入 `logs/wx_channel.log`，最大 5MB
  * 达到大小后自动按时间戳重命名并创建新文件
* **价值**：
  * 避免日志文件过大
  * 便于日志管理和查看
  * 提高可观测性
* **影响范围**：
  * `internal/utils/logger.go`（日志系统）
  * `main.go`（日志初始化）

***

### 未来优化计划

#### 短期计划（1-2 个月）

**11) 错误处理与重试机制增强**

* **优先级**：高
* **计划**：
  * 实现更细粒度的错误分类
  * 针对不同错误类型采用不同重试策略
  * 添加错误码与建议操作
  * 记录详细的错误日志

**12) 性能监控与统计**

* **优先级**：中
* **计划**：
  * 添加下载速度统计
  * 成功率统计
  * 平均下载时间统计
  * 资源使用情况监控

**13) 配置文件支持**

* **优先级**：中
* **计划**：
  * 支持 `config.json` 配置文件
  * 环境变量与配置文件优先级管理
  * 配置文件热重载（可选）

#### 中期计划（3-6 个月）

**14) 下载目录策略增强**

* **优先级**：中
* **计划**：
  * 支持选择保存根目录
  * 作者子目录开关
  * 文件名模板（时间戳/作者/标题/ID）
  * 自定义命名规则

**15) 日志系统增强**

* **优先级**：中
* **计划**：
  * 按日滚动日志
  * JSON 结构化日志
  * 日志级别动态调整
  * 日志查询接口

**16) 批量下载进度持久化**

* **优先级**：低
* **计划**：
  * 进度保存到本地文件
  * 程序重启后恢复进度
  * 支持断点续传

#### 长期计划（6 个月以上）

**17) Windows 系统托盘**

* **优先级**：低
* **计划**：
  * 系统托盘图标
  * 快速打开下载目录
  * 启动/停止代理
  * 查看日志
  * 系统通知

**18) Web 管理界面**

* **优先级**：低
* **计划**：
  * 提供 Web 管理界面
  * 查看下载记录
  * 管理下载任务
  * 查看统计信息
  * 配置管理

**19) 多用户支持**

* **优先级**：低
* **计划**：
  * 支持多用户配置
  * 用户隔离
  * 权限管理

***

### 性能指标

#### 当前性能表现

* **分片上传并发**：默认 4 并发
* **分片合并并发**：默认 1 并发
* **批量下载并发**：默认 2 并发
* **批量下载重试**：默认 3 次
* **CSV 去重**：O(1) 时间复杂度（内存索引）
* **日志滚动**：5MB 自动滚动

#### 优化目标

* **分片上传速度**：提升 20-30%
* **批量下载成功率**：达到 95% 以上
* **内存占用**：控制在 100MB 以内
* **启动时间**：3 秒以内

***

### 变更记录

* **2025-11-08**：
  * 补充详细的优化记录
  * 添加 UI/UX 优化说明
  * 添加批量下载功能详细说明
  * 添加解密功能说明
  * 添加导出功能说明
  * 添加日志系统优化说明
  * 添加未来优化计划
  * 添加性能指标
* **2025-11-04**：
  * UI/UX 优化：状态信息栏、自定义确认对话框
  * 批量下载功能增强
  * 多格式导出支持
  * 后端批量下载：去重、失败清单、前缀解密
  * 分片上传与并发限流优化
  * 日志默认开启（5MB 滚动）
* **2025-11-03**：
  * 添加文档并完成第一阶段两项优化（文件名/路径；安全响应头）
