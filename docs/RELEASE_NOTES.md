# 版本更新说明

## v5.1.0（2025-11-29）

### 🚀 性能优化

#### 1. 批量下载并发支持
- **并发下载**：支持多个视频同时下载（默认2个并发，可配置）
- **Worker Pool**：使用 goroutine 池管理下载任务
- **配置项**：`DownloadConcurrency` 控制并发数

#### 2. 断点续传
- **Range 请求**：支持 HTTP Range 请求，中断后可继续下载
- **临时文件**：下载中断后保留 .tmp 文件，下次自动续传
- **配置项**：`DownloadResumeEnabled` 开关（默认开启）
- **注意**：加密视频不支持断点续传

#### 3. 智能重试机制
- **指数退避**：重试延迟 2s → 4s → 8s...（指数增长）
- **随机抖动**：添加 0-1s 随机延迟，避免重试风暴
- **可配置**：`DownloadRetryCount` 控制重试次数
- **超时控制**：`DownloadTimeout` 控制单文件超时（默认10分钟）

#### 4. 取消时立即中断
- **Context 取消**：使用 context.CancelFunc 实现立即中断
- **资源清理**：取消后自动清理正在下载的临时文件

### ⚡ 前端优化

#### 1. Payload 大小优化
- **问题**：之前每个视频携带 128KB 解密数组，50个视频 = 9MB payload
- **解决**：只传 key（几十字节），后端自己生成解密数组
- **效果**：payload 大小从 ~170KB/视频 降到 ~1KB/视频

#### 2. 后端解密支持
- **Isaac64 算法**：Go 实现的 Isaac64 伪随机数生成器
- **自动解密**：后端从 key 生成 128KB 解密数组
- **兼容性**：同时支持 key（新）和 decryptorPrefix（旧）两种方式

#### 3. Web 控制台优化
- **移除 WASM**：不再需要前端加载 WASM 解密库
- **即时提交**：数据格式转换瞬间完成
- **简化流程**：直接传 key，后端处理解密

### 🔧 新增配置项

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `DownloadConcurrency` | int | 5 | 批量下载并发数 |
| `DownloadRetryCount` | int | 3 | 下载重试次数 |
| `DownloadResumeEnabled` | bool | true | 断点续传开关 |
| `DownloadTimeout` | Duration | 30min | 单文件下载超时 |

### 📊 性能对比

| 指标 | v5.0.0 | v5.1.0 | 提升 |
|------|--------|--------|------|
| 50视频 payload | 9 MB | ~50 KB | 180x |
| 构建 payload | 2-3秒 | 瞬间 | - |
| 下载速度 | 串行 | 2并发 | 2x |
| 中断恢复 | 重新下载 | 断点续传 | - |

### 🐛 问题修复

- **修复**：大量视频批量下载时 payload 过大导致请求卡住
- **修复**：取消下载后当前任务仍继续下载的问题
- **修复**：重试延迟固定导致的重试风暴问题

---

## v5.0.0（2025-11-23）

### 🎉 重大更新

这是一个重要的里程碑版本，标志着项目从日期版本号（v20251108）迁移到语义化版本号（v5.0.0）。

### ✨ 新增功能

#### 1. 批量下载系统
- **完整的批量下载功能**：支持一次下载多个视频
- **多种数据格式**：支持批量下载格式和账户导出格式
- **自动格式转换**：智能识别并转换数据格式
- **重试机制**：网络问题自动重试（最多3次）
- **进度监控**：实时显示下载进度和状态

#### 2. 加密视频支持
- **XOR 解密算法**：支持加密视频自动解密
- **WASM 集成**：自动加载微信 WASM 解密库
- **密钥自动处理**：自动处理 key 字段，生成 decryptorPrefix
- **完整视频保存**：解密后保存为可播放的 MP4 文件

#### 3. Web 控制台
- **微信风格界面**：简洁清爽的微信绿色主题
- **实时进度显示**：显示总任务数、已完成、失败、进行中
- **实时日志**：500条日志缓存，颜色区分不同类型
- **操作按钮**：开始、取消、导出失败清单、清空日志
- **响应式布局**：适配桌面和移动端

#### 4. 错误处理和恢复
- **Context 超时控制**：10分钟超时，避免长时间卡住
- **递增延迟重试**：2s、4s、6s 递增延迟策略
- **失败清单导出**：导出失败任务 JSON，便于重新下载
- **详细错误信息**：记录失败原因，便于排查

### 📚 文档完善

#### 1. 用户文档
- **批量下载使用指南**：完整的功能说明和使用方法
- **Web 控制台使用指南**：详细的界面说明和操作指南
- **快速开始指南**：5分钟快速上手

#### 2. 开发文档
- **批量下载 API 文档**：完整的 API 接口说明
- **加密视频详细说明**：加密原理和使用方法
- **开发记录**：完整的开发历程和问题修复记录

#### 3. 文档结构优化
- **主目录简洁**：只保留核心用户文档
- **详细文档分离**：技术文档和开发记录移至 fix 目录
- **分类清晰**：用户文档和开发文档明确分离

### 🔧 技术改进

#### 1. 代码质量
- **模块化设计**：批量下载处理器独立模块
- **错误处理完善**：完整的错误处理和日志记录
- **代码规范**：遵循 Go 语言规范

#### 2. 性能优化
- **HTTP 连接池**：复用 HTTP 连接，提高性能
- **缓冲区优化**：32KB 缓冲区，平衡内存和性能
- **串行下载**：避免对服务器造成压力

#### 3. 安全性
- **授权验证**：支持 Token 授权
- **CORS 支持**：配置允许的请求来源
- **数据安全**：解密密钥在内存中处理

### 🐛 问题修复

#### 1. 文件句柄泄漏
- **问题**：重命名临时文件时失败
- **修复**：在重命名前显式关闭文件句柄

#### 2. 加密视频处理
- **问题**：无法正确解密加密视频
- **修复**：集成 WASM 库，自动处理密钥转换

#### 3. 网络中断恢复
- **问题**：下载中断后卡住
- **修复**：Context 超时控制 + 自动重试机制

#### 4. 用户体验优化
- **问题**：界面不够直观
- **修复**：实时日志 + 进度显示 + 微信风格

### 📊 统计数据

- **新增代码**：约 720 行（批量下载功能）
- **新增文档**：17 篇（用户文档 + 开发文档）
- **修复问题**：4 个主要问题
- **优化项目**：文档结构、代码质量、性能

### 🎯 使用场景

1. **批量备份**：一次性下载多个视频进行备份
2. **离线观看**：下载视频后离线观看
3. **内容整理**：按作者分类整理视频
4. **加密视频**：自动解密加密的视频

### 📝 升级说明

#### 从旧版本升级

1. **下载新版本**：从 GitHub Releases 下载 v5.0.0
2. **替换可执行文件**：替换旧的 wx_channel.exe
3. **保留配置**：配置文件和下载目录无需更改
4. **查看文档**：阅读新的批量下载使用指南

#### 配置变更

- **版本号格式**：从日期格式（20251108）改为语义化版本（5.0.0）
- **无需修改配置**：所有配置保持向后兼容

### 🔮 未来计划

#### 短期（v5.2.0）
- [ ] 下载速度限制
- [ ] 下载历史记录
- [ ] 下载队列管理

#### 中期（v5.3.0）
- [ ] 视频预览
- [ ] 批量操作优化
- [ ] 更多导出格式

#### 长期（v6.0.0）
- [ ] 分布式下载
- [ ] 云存储支持
- [ ] 视频转码
- [ ] 移动端支持

### 📞 获取帮助

- **文档**：查看 [docs/](../docs/) 目录下的完整文档
- **问题反馈**：通过 [GitHub Issues](https://github.com/nobiyou/wx_channel/issues) 反馈
- **讨论交流**：查看项目 README 中的联系方式

### 🙏 致谢

感谢所有用户的反馈和建议，帮助我们不断改进项目。

---

## 历史版本

### v20251108（2024-11-08）

- **UI/UX 优化**：状态信息栏、自定义确认对话框
- **批量下载**：支持前端和后端批量下载，支持选择下载
- **多格式导出**：支持 TXT、JSON、Markdown 格式
- **加密支持**：支持加密视频的前缀解密
- **日志系统**：默认开启，支持文件大小滚动
- **性能优化**：分片上传并发控制、CSV 去重优化

### 更早版本

更早版本的更新记录请查看 [GitHub Releases](https://github.com/nobiyou/wx_channel/releases)。

---

**版本号说明**：

从 v5.0.0 开始，项目采用语义化版本号（Semantic Versioning）：
- **主版本号**：重大更新，可能包含不兼容的 API 变更
- **次版本号**：新增功能，向后兼容
- **修订号**：问题修复，向后兼容
- **构建号**：构建版本，通常为 0

当前版本：**v5.1.0.0**

---

最后更新：2025-11-29
